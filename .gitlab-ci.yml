image: docker:26.0.0

services:
  - name: docker:26.0.0-dind
    alias: docker

workflow:
  rules:
    - if: $CI_PIPELINE_SOURCE == "push"

stages:
  - build
  - test
  - deploy

build:
  stage: build
  script:
    - docker-compose down --remove-orphans
    - docker-compose build

test-backend:
  image: maven:3.8.7-openjdk-18-slim
  stage: test
  tags:
    - docker
  services:
    - name: mysql:5.7
  variables:
    MYSQL_DATABASE: hobbie_db
    MYSQL_ROOT_PASSWORD: root
  script:
    - cd spring-backend
    - mvn test

test-frontend:
  image: node:18-alpine
  stage: test
  tags:
    - docker
  before_script:
    - cd react-frontend
  script:
    - npm install
    - npm run test

deploy:
  stage: deploy
  tags:
    - docker
  script:
    - docker login ${CI_REGISTRY} -u ${CI_REGISTRY_USER} --password-stdin ${CI_JOB_TOKEN}
    - docker-compose build

    - docker tag springboot-backend:latest ${CI_REGISTRY_IMAGE}/${CI_COMMIT_REF_NAME}-springboot-backend:latest
    - docker push ${CI_REGISTRY_IMAGE}/${CI_COMMIT_REF_NAME}-springboot-backend:latest
    - docker tag ${CI_REGISTRY_IMAGE}/${CI_COMMIT_REF_NAME}-springboot-backend:latest ${CI_REGISTRY_IMAGE}/${CI_COMMIT_REF_NAME}-springboot-backend:${CI_COMMIT_SHORT_SHA}
    - docker push ${CI_REGISTRY_IMAGE}/${CI_COMMIT_REF_NAME}-springboot-backend:${CI_COMMIT_SHORT_SHA}
  
    - docker tag react-frontend:latest ${CI_REGISTRY_IMAGE}/${CI_COMMIT_REF_NAME}-react-frontend:latest
    - docker push ${CI_REGISTRY_IMAGE}/${CI_COMMIT_REF_NAME}-react-frontend:latest
    - docker tag ${CI_REGISTRY_IMAGE}/${CI_COMMIT_REF_NAME}-react-frontend:latest ${CI_REGISTRY_IMAGE}/${CI_COMMIT_REF_NAME}-react-frontend:${CI_COMMIT_SHORT_SHA}
    - docker push ${CI_REGISTRY_IMAGE}/${CI_COMMIT_REF_NAME}-react-frontend:${CI_COMMIT_SHORT_SHA}

    - docker tag nginx:latest ${CI_REGISTRY_IMAGE}/${CI_COMMIT_REF_NAME}-nginx:latest
    - docker push ${CI_REGISTRY_IMAGE}/${CI_COMMIT_REF_NAME}-nginx:latest
    - docker tag ${CI_REGISTRY_IMAGE}/${CI_COMMIT_REF_NAME]-nginx:latest ${CI_REGISTRY_IMAGE}/${CI_COMMIT_REF_NAME}-nginx:${CI_COMMIT_SHORT_SHA}
    - docker push ${CI_REGISTRY_IMAGE}/${CI_COMMIT_REF_NAME}-nginx:${CI_COMMIT_SHORT_SHA}

